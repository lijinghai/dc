"use strict"; function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }




var _chunkGM2VR4AOjs = require('./chunk-GM2VR4AO.js');

// src/nr.ts
var import_prompts = _chunkGM2VR4AOjs.__toModule.call(void 0, _chunkGM2VR4AOjs.require_prompts.call(void 0, ));

// src/storage.ts
var _fs = require('fs'); var _fs2 = _interopRequireDefault(_fs);
var _path = require('path');
var storage;
var storagePath = _path.join.call(void 0, __dirname, "_storage.json");
async function load(fn) {
  if (!storage) {
    storage = _fs.existsSync.call(void 0, storagePath) ? JSON.parse(await _fs.promises.readFile(storagePath, "utf-8")) || {} : {};
  }
  if (fn) {
    if (await fn(storage))
      await dump();
  }
  return storage;
}
async function dump() {
  if (storage)
    await _fs.promises.writeFile(storagePath, JSON.stringify(storage), "utf-8");
}

// src/fs.ts


function getPackageJSON(cwd = process.cwd()) {
  const path = _path.resolve.call(void 0, cwd, "package.json");
  if (_fs2.default.existsSync(path)) {
    try {
      const raw = _fs2.default.readFileSync(path, "utf-8");
      const data = JSON.parse(raw);
      return data;
    } catch (e) {
      console.warn("Failed to parse package.json");
      process.exit(0);
    }
  }
}

// src/nr.ts
_chunkGM2VR4AOjs.runCli.call(void 0, async (agent, args, ctx) => {
  const storage2 = await load();
  if (args[0] === "-") {
    if (!storage2.lastRunCommand) {
      console.error("No last command found");
      process.exit(1);
    }
    args[0] = storage2.lastRunCommand;
  }
  if (args.length === 0) {
    const pkg = getPackageJSON(ctx == null ? void 0 : ctx.cwd);
    const scripts = pkg.scripts || {};
    const scriptsInfo = pkg["scripts-info"] || {};
    const names = Object.entries(scripts);
    if (!names.length)
      return;
    const choices = names.filter((i) => !i[0].startsWith("?")).map(([value, cmd]) => ({
      title: value,
      value,
      description: scriptsInfo[value] || scripts[`?${value}`] || cmd
    }));
    if (storage2.lastRunCommand) {
      const last = choices.find((i) => i.value === storage2.lastRunCommand);
      if (last)
        choices.unshift(last);
    }
    try {
      const { fn } = await (0, import_prompts.default)({
        name: "fn",
        message: "script to run",
        type: "autocomplete",
        choices
      });
      if (!fn)
        return;
      args.push(fn);
    } catch (e) {
      process.exit(1);
    }
  }
  if (storage2.lastRunCommand !== args[0]) {
    storage2.lastRunCommand = args[0];
    dump();
  }
  return _chunkGM2VR4AOjs.parseNr.call(void 0, agent, args);
});
